<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>
        <video id="self" controls autoplay style="width:300px;height:200px;border:1px solid grey"></video>
        <video id="remote" controls autoplay style="width:300px;height:200px;border:1px solid grey"></video>
    </div>
    <script>
        console.log(navigator)
        const socket = new WebSocket("wss://localhost:5005")
        socket.onopen = () => {
            socket.send(JSON.stringify({
                command: "connect",
                roomId: 123,
                user_id: Math.random()
            }))
            const configuration = {
                iceServers: [{
                    urls: 'stun:stun.l.google.com:19302'
                }]
            };
            const pc = new RTCPeerConnection(configuration);

            // Send any ice candidates to the other peer.
            pc.onicecandidate = ({ candidate }) => socket.send(JSON.stringify({
                command: "iceCandidateProposal",
                ice: candidate,
                roomId: 123
            }));

            // Let the "negotiationneeded" event trigger offer generation.
            pc.onnegotiationneeded = () => {
                try {
                    pc.setLocalDescription(pc.createOffer())
                        .then(() => {
                            // Send the offer to the other peer.
                            socket.send(JSON.stringify({
                                command: "offer",
                                sdp: pc.localDescription,
                                roomId: 123
                            }));
                        })
                } catch (err) {
                    console.error(err);
                }
            };

            // Once remote track media arrives, show it in remote video element.
            pc.ontrack = (event) => {

                const remoteView = document.getElementById("remote")
                remoteView.srcObject = event.streams[0];
            };

            // Call start() to initiate.
            (function start() {
                // try {
                // Get local stream, show it in self-view, and add it to be sent.
                navigator.mediaDevices.getUserMedia({
                    video: true
                })
                    .then(stream => {
                        stream.getTracks().forEach((track) => pc.addTrack(track, stream));
                        const selfView = document.getElementById("self")
                        selfView.srcObject = stream;
                    })
                // } catch (err) {
                //     console.error(err);
                // }
            })()
            socket.onmessage = ({ data }) => {
                data = JSON.parse(data)
                // console.log(data.event, data)
                // try {
                if (data.event === "offer") {
                    // console.log('got offer')
                    pc.setRemoteDescription(data.sdp)
                        .then(async () => {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                            await stream.getTracks().forEach((track) => pc.addTrack(track, stream));
                            pc.setLocalDescription(pc.createAnswer())
                                .then(() => {
                                    socket.send(JSON.stringify({
                                        command: "answer",
                                        sdp: pc.localDescription,
                                        roomId: 123
                                    }))
                                })
                        })
                } else if (data.event === 'answer') {
                    pc.setRemoteDescription(data.sdp)
                } else if (data.event === "iceCandidateProposal") {
                    pc.addIceCandidate(data.ice)
                        .catch(() => {
                            // console.log(data.ice)
                        })
                }
                // } catch (err) {
                //     console.error(err);
                // }
            };
        }


    </script>
</body>

</html>